# 模型训练问题诊断报告

## 问题总结

### 1. 模型文件状态 ❌

**检查结果**:
- ❌ `models/text_rewriter_model/` 目录不存在
- ❌ 没有 `.h5` 模型文件
- ❌ 没有 `vocab.json` 词汇表文件

**结论**: **模型未生成**

### 2. 训练数据问题 ❌

**文件**: `data/training/processed/training_data.txt`

**问题**:
1. **格式错误**: 文件包含的是小说原始内容，而不是TSV格式的训练数据
2. **文件开头**: `==================================================` (分隔线)
3. **内容**: 包含小说正文，而不是 `原始文本<TAB>改写文本<TAB>风格ID` 格式
4. **有效数据**: 前10000行中，有效行数为0

**从日志看**:
```
✅ 成功加载 0 条有效数据
❌ 没有可用的训练数据
❌ 没有训练数据，退出
```

### 3. 根本原因

**问题**: 训练数据文件被错误覆盖

**可能原因**:
1. 训练数据生成时，`training_samples` 为空或格式错误
2. 文件被其他代码错误覆盖
3. 保存逻辑有问题，导致写入了错误内容

**证据**:
- 文件开头是分隔线 `==================================================`
- 文件包含小说正文内容
- 只有最后几行包含TAB分隔符
- 文件大小28.73 MB，但格式不正确

## 修复方案

### 方案1: 重新生成训练数据（推荐）✅

**步骤**:
1. 删除错误的训练数据文件
2. 重新运行训练数据生成
3. 验证格式正确性
4. 重新训练模型

**命令**:
```bash
# 删除错误的训练数据
rm data/training/processed/training_data.txt

# 重新生成训练数据
python3 scripts/core/pipeline.py \
  --skip scrape,organize \
  --epochs 10 \
  --batch-size 8
```

### 方案2: 检查并修复数据生成逻辑

**需要检查**:
1. `training_samples` 是否正确生成
2. 保存逻辑是否正确
3. 是否有其他代码覆盖了文件

## 当前状态

| 项目 | 状态 | 详情 |
|------|------|------|
| 模型文件 | ❌ 不存在 | `models/text_rewriter_model/` 目录不存在 |
| 训练数据 | ❌ 格式错误 | 文件包含小说内容，不是TSV格式 |
| 训练过程 | ❌ 未执行 | 因数据格式问题，训练未开始 |
| 数据量 | ⚠️ 未知 | 文件存在但格式错误 |

## 下一步行动

### 立即执行

1. **删除错误的训练数据文件**
   ```bash
   rm data/training/processed/training_data.txt
   ```

2. **重新生成训练数据**
   ```bash
   python3 scripts/core/pipeline.py \
     --skip scrape,organize \
     --epochs 10 \
     --batch-size 8
   ```

3. **验证训练数据格式**
   - 检查前几行是否包含TAB
   - 检查格式是否为：`原始文本<TAB>改写文本<TAB>风格ID`

4. **重新训练模型**
   - 确保训练数据格式正确后
   - 运行完整训练流程

### 长期改进

1. **添加数据格式验证**
   - 保存前验证格式
   - 加载前验证格式

2. **改进错误处理**
   - 当 `training_samples` 为空时，给出明确提示
   - 当格式错误时，提供修复建议

3. **添加训练状态检查**
   - 检查模型是否成功生成
   - 提供训练进度显示

## 相关文件

- `data/training/processed/training_data.txt` - 训练数据文件（格式错误，需要重新生成）
- `scripts/core/training_data_generator.py` - 训练数据生成器
- `scripts/ai/models/train_model.py` - 模型训练脚本
- `models/text_rewriter_model/` - 模型保存目录（不存在）

